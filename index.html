<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oto Yıkama Takip Sistemi</title>
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Global sıfırlamalar */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body stilleri */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); /* Mor-mavi degrade arka plan */
            min-height: 100vh; /* Tam ekran yüksekliği */
            color: #333; /* Varsayılan metin rengi */
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Ana konteyner stilleri */
        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1); /* Yarı şeffaf beyaz arka plan */
            backdrop-filter: blur(10px); /* Arka plan bulanıklığı */
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2); /* Büyük gölge efekti */
        }

        /* Başlık alanı stilleri */
        .header {
            background: rgba(255, 255, 255, 0.15); /* Yarı şeffaf beyaz arka plan */
            backdrop-filter: blur(10px); /* Arka plan bulanıklığı */
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white; /* Metin rengi */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap; /* Küçük ekranlarda sarmalama */
        }

        /* Logo stilleri */
        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Navigasyon butonları stilleri */
        .nav-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Genel buton stilleri */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease; /* Yumuşak geçiş efektleri */
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        /* Birincil buton stilleri */
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2); /* Mor-mavi degrade */
            color: white;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
        }

        /* İkincil buton stilleri */
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Tehlike (kırmızı) buton stilleri */
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b); /* Kırmızı degrade */
            color: white;
        }

        /* Başarı (yeşil) buton stilleri */
        .btn-success {
            background: linear-gradient(45deg, #2ecc71, #27ae60); /* Yeşil degrade */
            color: white;
        }

        /* Buton hover efekti */
        .btn:hover:not(:disabled) {
            transform: translateY(-2px); /* Hafif yukarı kayma */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); /* Gölge büyümesi */
        }

        /* Engelli buton stilleri */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Ekran (sayfa) stilleri */
        .screen {
            display: none; /* Varsayılan olarak gizli */
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        /* Aktif ekran stilleri */
        .screen.active {
            display: block; /* Aktif olduğunda görünür */
            animation: fadeIn 0.5s ease-out; /* Açılış animasyonu */
        }

        /* FadeIn animasyonu */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form grubu stilleri */
        .form-group {
            margin-bottom: 20px;
        }

        /* Etiket stilleri */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        /* Input, select, textarea stilleri */
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: #fcfcfc;
        }

        /* Input, select, textarea focus stilleri */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }

        /* Arama kutusu konteyneri stilleri */
        .search-container {
            position: relative;
            margin-bottom: 30px;
        }

        /* Arama inputu stilleri */
        .search-input {
            padding-left: 50px;
            font-size: 18px;
            height: 60px;
            border-radius: 30px;
            background-color: #f0f0f0;
        }

        /* Arama ikonu stilleri */
        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #667eea;
        }

        /* Araç kartı stilleri */
        .car-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #e0e6f0 100%);
            border-radius: 18px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        /* Araç kartı hover efekti */
        .car-card:hover {
            transform: translateY(-5px);
        }

        /* Araç kartı başlığı stilleri */
        .car-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Plaka numarası stilleri */
        .plate-number {
            font-size: 26px;
            font-weight: bold;
            color: #4a5ee5;
        }

        /* Durum etiketi stilleri */
        .status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
        }

        /* Durum renkleri */
        .status.waiting { background: #ffd54f; color: #f57f17; } /* Sarı */
        .status.washing { background: #64b5f6; color: #1976d2; } /* Açık mavi */
        .status.drying { background: #a5d6a7; color: #2e7d32; } /* Açık yeşil */
        .status.ready { background: #ffab91; color: #bf360c; } /* Turuncu */
        .status.completed { background: #b0bec5; color: #455a64; } /* Gri */

        /* Araç detayları grid stilleri */
        .car-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* Detay öğesi stilleri */
        .detail-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 10px;
        }

        /* Detay etiketi stilleri */
        .detail-label {
            font-size: 12px;
            color: #777;
            margin-bottom: 5px;
        }

        /* Detay değeri stilleri */
        .detail-value {
            font-weight: bold;
            color: #333;
        }

        /* Giriş formu stilleri */
        .login-form {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
        }

        /* Hoşgeldin metni stilleri */
        .welcome-text {
            font-size: 28px;
            margin-bottom: 30px;
            color: #667eea;
            font-weight: bold;
        }

        /* Form grid stilleri */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Bölüm başlığı stilleri */
        .section-header {
            background: rgba(248, 249, 250, 0.9);
            padding: 25px;
            border-radius: 18px;
            margin-bottom: 30px;
        }

        .section-header h3 {
            color: #4a5ee5;
            margin-bottom: 20px;
            font-size: 22px;
        }

        /* Durum kontrol butonları stilleri */
        .status-controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Durum butonu stilleri */
        .status-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background-color: #f0f0f0;
            color: #555;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .status-btn:hover {
            transform: translateY(-1px);
        }

        .status-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        /* Bildirim kutusu stilleri */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            transform: translateX(100%); /* Başlangıçta ekran dışı */
            transition: transform 0.3s ease; /* Yumuşak giriş */
        }

        .notification.show {
            transform: translateX(0); /* Gösterildiğinde ekrana gir */
        }

        .notification.success { background: #4caf50; } /* Yeşil */
        .notification.error { background: #f44336; } /* Kırmızı */
        .notification.info { background: #2196f3; } /* Mavi */

        /* Raporlar grid stilleri */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Rapor kartı stilleri */
        .report-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        /* Rapor numarası stilleri */
        .report-number {
            font-size: 36px;
            font-weight: bold;
            color: #1976d2;
        }

        /* Rapor etiketi stilleri */
        .report-label {
            font-size: 14px;
            color: #666;
        }

        /* Yükleniyor stilleri */
        .loading {
            text-align: center;
            padding: 40px;
            color: #777;
        }

        /* Buton grubu stilleri */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        /* Firebase yapılandırma hata stilleri */
        .config-error {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .config-error h2 {
            color: #e74c3c;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .config-instructions {
            text-align: left;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        /* Geri Bildirim Bölümü Stillleri */
        .feedback-section {
            margin-top: 40px;
            animation: slideDown 0.5s ease-out;
        }

        .feedback-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); /* Turuncu tonlarda degrade */
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid #ffcc02; /* Sarı çerçeve */
        }

        .feedback-card h3 {
            color: #f57c00; /* Turuncu başlık */
            margin-bottom: 15px;
            font-size: 24px;
            text-align: center;
        }

        .rating-container {
            text-align: center;
            margin-bottom: 25px;
        }

        .star-rating {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
        }

        .star {
            font-size: 32px;
            cursor: pointer;
            transition: all 0.2s ease;
            filter: grayscale(100%); /* Pasif yıldızlar gri */
        }

        .star:hover,
        .star.active {
            filter: grayscale(0%); /* Aktif/hover yıldızlar renkli */
            transform: scale(1.1);
        }

        .rating-text {
            font-size: 14px;
            color: #f57c00;
            font-weight: bold;
        }

        /* Geri bildirim gelen kutusu stilleri */
        .feedback-inbox {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .feedback-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #4a5ee5; /* Sol kenarlık */
        }

        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .feedback-rating {
            display: flex;
            gap: 2px;
        }

        .feedback-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .feedback-comment {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-style: italic;
            color: #555;
        }

        .feedback-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .no-feedback {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px 20px;
        }

        /* Animasyonlar */
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Duyarlı tasarım (mobil uyumluluk) */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons {
                justify-content: center;
                width: 100%;
            }

            .container {
                padding: 15px;
            }

            .screen {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr; /* Tek sütunlu düzen */
            }

            .feedback-card {
                padding: 20px;
            }

            .star {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fa-solid fa-car-wash"></i> Oto Yıkama Takip Sistemi
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="showLogin()" id="loginBtn">
                    <i class="fa-solid fa-sign-in-alt"></i> Giriş Yap
                </button>
                <button class="btn btn-primary" onclick="showCustomerSearch()" id="customerBtn">
                    <i class="fa-solid fa-search"></i> Araç Sorgula
                </button>
                <button class="btn btn-secondary" onclick="showEmployeePanel()" id="employeeBtn" style="display: none;">
                    <i class="fa-solid fa-users-gear"></i> Çalışan Paneli
                </button>
                <button class="btn btn-secondary" onclick="showAdminPanel()" id="adminBtn" style="display: none;">
                    <i class="fa-solid fa-user-gear"></i> Admin Paneli
                </button>
                <button class="btn btn-secondary" onclick="showReports()" id="reportsBtn" style="display: none;">
                    <i class="fa-solid fa-chart-line"></i> Raporlar
                </button>
                <button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="display: none;">
                    <i class="fa-solid fa-sign-out-alt"></i> Çıkış
                </button>
            </div>
        </div>

        <!-- Giriş Ekranı -->
        <div id="loginScreen" class="screen">
            <div class="login-form">
                <h2 class="welcome-text">Sisteme Giriş</h2>
                <div class="form-group">
                    <label for="email">E-posta</label>
                    <input type="email" id="email" placeholder="E-posta adresinizi girin" required>
                </div>
                <div class="form-group">
                    <label for="password">Şifre</label>
                    <input type="password" id="password" placeholder="Şifrenizi girin" required>
                </div>
                <button class="btn btn-primary" onclick="login()">
                    <i class="fa-solid fa-sign-in-alt"></i> Giriş Yap
                </button>
            </div>
        </div>

        <!-- Müşteri Sorgu Ekranı -->
        <div id="customerScreen" class="screen active">
            <h2><i class="fa-solid fa-search"></i> Araç Durumu Sorgula</h2>
            <div class="search-container">
                <div class="search-icon">🔍</div>
                <input type="text" class="search-input" id="plateSearch" 
                       placeholder="Plaka numarasını girin (örn: 34ABC123)" 
                       oninput="searchCar()">
            </div>
            
            <div id="carResults">
                <p style="text-align: center; color: #777;">
                    Plaka numarasını girerek araç durumunu sorgulayabilirsiniz.
                </p>
            </div>

            <!-- Geri Bildirim Bölümü -->
            <div class="feedback-section" id="feedbackSection" style="display: none;">
                <div class="feedback-card">
                    <h3><i class="fa-solid fa-star"></i> Hizmetimizi Değerlendirin</h3>
                    <p>Araç yıkama hizmetimizden memnun kaldınız mı? Görüşleriniz bizim için değerli!</p>
                    
                    <div class="rating-container">
                        <label>Puan Verin:</label>
                        <div class="star-rating" id="starRating">
                            <span class="star" data-rating="1">⭐</span>
                            <span class="star" data-rating="2">⭐</span>
                            <span class="star" data-rating="3">⭐</span>
                            <span class="star" data-rating="4">⭐</span>
                            <span class="star" data-rating="5">⭐</span>
                        </div>
                        <div class="rating-text" id="ratingText">Puan seçin</div>
                    </div>

                    <div class="form-group">
                        <label for="feedbackComment">Yorumunuz (İsteğe bağlı):</label>
                        <textarea id="feedbackComment" 
                                  placeholder="Hizmetimiz hakkında düşüncelerinizi paylaşın..." 
                                  rows="4"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="customerNameFeedback">Adınız (İsteğe bağlı):</label>
                        <input type="text" id="customerNameFeedback" placeholder="Adınız">
                    </div>

                    <button class="btn btn-primary" onclick="submitFeedback()" id="submitFeedbackBtn">
                        <i class="fa-solid fa-paper-plane"></i> Geri Bildirim Gönder
                    </button>
                </div>
            </div>
        </div>

        <!-- Çalışan Paneli -->
        <div id="employeeScreen" class="screen">
            <h2><i class="fa-solid fa-users-gear"></i> Çalışan Paneli</h2>
            
            <div class="section-header">
                <h3 id="carFormTitle"><i class="fa-solid fa-plus"></i> Yeni Araç Ekle</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newPlate">Plaka Numarası</label>
                        <input type="text" id="newPlate" placeholder="34ABC123" required>
                    </div>
                    <div class="form-group">
                        <label for="customerName">Müşteri Adı</label>
                        <input type="text" id="customerName" placeholder="Müşteri adı">
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Telefon</label>
                        <input type="tel" id="customerPhone" placeholder="05551234567">
                    </div>
                    <div class="form-group">
                        <label for="serviceType">Hizmet Türü</label>
                        <select id="serviceType">
                            <option value="Dış Yıkama">Dış Yıkama</option>
                            <option value="İç Dış Yıkama">İç Dış Yıkama</option>
                            <option value="Detaylı Yıkama">Detaylı Yıkama</option>
                            <option value="Cila">Cila</option>
                            <option value="Nano Koruma">Nano Koruma</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="estimatedTime">Tahmini Süre (dk)</label>
                        <input type="number" id="estimatedTime" placeholder="45" min="1">
                    </div>
                    <div class="form-group">
                        <label for="price">Fiyat (₺)</label>
                        <input type="number" id="price" placeholder="150" min="0">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addCar()">
                    <i class="fa-solid fa-plus"></i> Araç Ekle
                </button>
            </div>

            <h3><i class="fa-solid fa-list"></i> Aktif Araçlar</h3>
            <div id="employeeCarList" class="loading">
                <i class="fa-solid fa-spinner fa-spin"></i> Yükleniyor...
            </div>
        </div>

        <!-- Admin Paneli -->
        <div id="adminScreen" class="screen">
            <h2><i class="fa-solid fa-user-gear"></i> Admin Paneli</h2>
            
            <!-- Geri Bildirim Gelen Kutusu -->
            <div class="section-header">
                <h3><i class="fa-solid fa-inbox"></i> Geri Bildirim Gelen Kutusu</h3>
                <div class="feedback-inbox" id="feedbackInbox">
                    <div class="loading">
                        <i class="fa-solid fa-spinner fa-spin"></i> Yükleniyor...
                    </div>
                </div>
            </div>

            <div class="section-header">
                <h3><i class="fa-solid fa-user-plus"></i> Çalışan Ekle</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newUserEmail">E-posta</label>
                        <input type="email" id="newUserEmail" placeholder="calisan@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="newUserPassword">Şifre</label>
                        <input type="password" id="newUserPassword" placeholder="En az 6 karakter" required>
                    </div>
                    <div class="form-group">
                        <label for="newUserName">Ad Soyad</label>
                        <input type="text" id="newUserName" placeholder="Çalışan adı" required>
                    </div>
                    <div class="form-group">
                        <label for="newUserRole">Rol</label>
                        <select id="newUserRole">
                            <option value="employee">Çalışan</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addUser()">
                    <i class="fa-solid fa-user-plus"></i> Kullanıcı Ekle
                </button>
            </div>

            <h3><i class="fa-solid fa-users"></i> Kullanıcılar</h3>
            <div id="userList" class="loading">
                <i class="fa-solid fa-spinner fa-spin"></i> Yükleniyor...
            </div>
        </div>

        <!-- Raporlar -->
        <div id="reportsScreen" class="screen">
            <h2><i class="fa-solid fa-chart-line"></i> Günlük Raporlar</h2>
            
            <div class="report-grid">
                <div class="report-card">
                    <div class="report-number" id="totalCars">0</div>
                    <div class="report-label">Toplam Araç</div>
                </div>
                <div class="report-card">
                    <div class="report-number" id="activeCars">0</div>
                    <div class="report-label">Aktif Araç</div>
                </div>
                <div class="report-card">
                    <div class="report-number" id="completedCars">0</div>
                    <div class="report-label">Tamamlanan</div>
                </div>
                <div class="report-card">
                    <div class="report-number" id="totalRevenue">₺0</div>
                    <div class="report-label">Günlük Gelir</div>
                </div>
                <div class="report-card">
                    <div class="report-number" id="avgRating">0.0</div>
                    <div class="report-label">Ortalama Puan</div>
                </div>
            </div>

            <h3><i class="fa-solid fa-history"></i> Günlük Araçlar</h3>
            <div id="dailyCarsList" class="loading">
                <i class="fa-solid fa-spinner fa-spin"></i> Yükleniyor...
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script type="module">
        // Firebase kütüphanelerini içe aktarma
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, onSnapshot, setDoc, getDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

        /*
         * Firebase Firestore Güvenlik Kuralları Hakkında Önemli Bilgi:
         *
         * Bu hatayı ('Missing or insufficient permissions') gidermek için, Firebase projenizin
         * Firestore veritabanı güvenlik kurallarını (Firebase konsolunda 'Firestore Database' -> 'Rules' sekmesi altında bulunur)
         * uygulamanızın veri okuma/yazma gereksinimlerine göre güncellemeniz GEREKMEKTEDİR.
         *
         * Aşağıdaki örnek kurallar, uygulamanın çalışması için gerekli minimum izinleri sağlar.
         * Kendi uygulamanızın güvenlik gereksinimlerine göre bu kuralları daha fazla özelleştirmelisiniz.
         *
         * Firebase Konsolunuzda (console.firebase.google.com) aşağıdaki kuralları yapıştırın:
         */
        /*
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Kullanıcıların kimlik doğrulamasından geçmesi gerekiyor.
            function isSignedIn() {
              return request.auth != null;
            }

            // Bir kullanıcının 'admin' rolüne sahip olup olmadığını kontrol eden fonksiyon.
            function isAdmin() {
              return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
            }

            // 'cars' koleksiyonu için kurallar
            // Tüm kimlik doğrulaması yapılmış kullanıcılar araçları okuyabilir.
            // Sadece kimlik doğrulaması yapılmış kullanıcılar araç ekleyebilir (şimdilik, daha sonra rol tabanlı eklenebilir).
            // Sadece kimlik doğrulaması yapılmış kullanıcılar durumu güncelleyebilir.
            // Sadece adminler araç silebilir.
            match /cars/{carId} {
              allow read: if isSignedIn();
              allow create: if isSignedIn();
              allow update: if isSignedIn();
              allow delete: if isAdmin();
            }

            // 'feedbacks' koleksiyonu için kurallar
            // Tüm kimlik doğrulaması yapılmış kullanıcılar geri bildirim oluşturabilir.
            // Sadece adminler tüm geri bildirimleri okuyabilir, güncelleyebilir (okundu olarak işaretleme) ve silebilir.
            match /feedbacks/{feedbackId} {
              allow create: if isSignedIn();
              allow read, update, delete: if isAdmin();
            }

            // 'users' koleksiyonu için kurallar
            // Kullanıcılar kendi profillerini okuyabilir.
            // Yeni kullanıcılar kimlik doğrulamadan sonra kendi dokümanlarını oluşturabilir.
            // Adminler tüm kullanıcıları okuyabilir, oluşturabilir ve güncelleyebilir.
            match /users/{userId} {
              allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
              allow create: if isSignedIn() && request.auth.uid == userId; // Sadece kendi profilini oluşturabilir
              allow update: if isAdmin(); // Sadece adminler diğer kullanıcıların rollerini/bilgilerini güncelleyebilir
              allow delete: if isAdmin();
            }
          }
        }
        */

        // Firebase yapılandırmanızı BURAYA EKLEYİN
        // Bu bilgileri Firebase Proje Ayarları -> Genel bölümünden alabilirsiniz.
        const firebaseConfig = {
  apiKey: "AIzaSyA6X-ZdiA11kK4R0D-09qlboQKmzhFOq1o",
  authDomain: "projecty-3d9d1.firebaseapp.com",
  projectId: "projecty-3d9d1",
  storageBucket: "projecty-3d9d1.firebasestorage.app",
  messagingSenderId: "158211801481",
  appId: "1:158211801481:web:78494e1dfed54e98a56158",
  measurementId: "G-B6V1Y6HT2Y"
};

        // Firebase değişkenleri
        let app;
        let auth;
        let db;

        // Global uygulama durumu değişkenleri
        let currentUser = null;
        let cars = [];
        let users = [];
        let feedbacks = [];
        let unsubscribers = [];
        let selectedRating = 0;
        let searchedPlate = '';

        // Firebase yapılandırmasını doğrula
        function validateFirebaseConfig() {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                return { isValid: false, message: 'Firebase API anahtarı eksik veya hatalı. Lütfen firebaseConfig objesini güncelleyin.' };
            }
            return { isValid: true };
        }

        // Yapılandırma hatası ekranını göster
        function showConfigError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = '<div class="config-error">' +
                '<i class="fa-solid fa-triangle-exclamation error-icon" style="color: #e74c3c;"></i>' +
                '<h2>Firebase Yapılandırma Hatası</h2>' +
                '<p>' + message + '</p>' +
                '<div class="config-instructions">' +
                '<h3>Lütfen şu adımları takip edin:</h3>' +
                '<ol>' +
                '<li><strong>Firebase konsolunu ziyaret edin:</strong> <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a></li>' +
                '<li><strong>Yeni proje oluşturun</strong> veya mevcut projenizi seçin</li>' +
                '<li><strong>Proje ayarları → Genel</strong> bölümüne gidin</li>' +
                '<li><strong>"Uygulamalarınız"</strong> kısmında Web uygulaması ekleyin</li>' +
                '<li><strong>Firebase SDK snippet\'ini kopyalayın</strong></li>' +
                '<li><strong>Authentication → Sign-in method</strong> kısmında Email/Password\'ü etkinleştirin</li>' +
                '<li><strong>Firestore Database</strong> oluşturun</li>' +
                '<li><strong>Kopyaladığınız config\'i kod içindeki firebaseConfig objesine yapıştırın</strong></li>' +
                '</ol>' +
                '</div>' +
                '<button class="btn btn-primary" onclick="location.reload()">' +
                '<i class="fa-solid fa-refresh"></i> Sayfayı Yenile' +
                '</button>' +
                '</div>';
        }

        // Firebase'i başlat
        async function initFirebase() {
            try {
                const configValidation = validateFirebaseConfig();
                if (!configValidation.isValid) {
                    showConfigError(configValidation.message);
                    return;
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                console.log("Firebase başarıyla başlatıldı");
                showNotification("Firebase bağlantısı kuruldu", "success");
                
                // Kimlik doğrulama durumu değiştiğinde UI'ı güncelle
                onAuthStateChanged(auth, async (user) => {
                    console.log("Auth state değişti:", user ? user.uid : "Çıkış yapıldı");
                    if (user) {
                        await loadUserData(user);
                        // Kullanıcı verisi yüklendikten sonra günlük temizliği kontrol et
                        checkDailyCleanup(); 
                    } else {
                        currentUser = null;
                        updateUI();
                        showCustomerSearch(); // Çıkış yapıldığında müşteri sorgu ekranına dön
                    }
                });
                
            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                let errorMessage = "Firebase bağlantı hatası";
                if (error.code === 'auth/api-key-not-valid') {
                    errorMessage = "Geçersiz API anahtarı. Firebase konfigürasyonunu kontrol edin.";
                } else if (error.code === 'auth/invalid-api-key') {
                    errorMessage = "Geçersiz API anahtarı formatı.";
                }
                showConfigError(errorMessage);
            }
        }

        // Kullanıcı verilerini Firestore'dan yükle
        async function loadUserData(user) {
            try {
                console.log("Kullanıcı verisi yükleniyor:", user.uid);
                // Kullanıcının rolünü al
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        ...userData
                    };
                    console.log("Kullanıcı verisi yüklendi:", currentUser);
                    showNotification('Hoş geldiniz ' + currentUser.name + '!', 'success');
                    updateUI(); // UI'ı kullanıcının rolüne göre güncelle
                    setupRealtimeListeners(); // Gerçek zamanlı dinleyicileri başlat
                    
                    // Kullanıcı rolüne göre varsayılan paneli göster
                    if (currentUser.role === 'admin') {
                        showEmployeePanel(); // Adminler doğrudan çalışan paneline gitsin
                    } else if (currentUser.role === 'employee') {
                        showEmployeePanel();
                    }
                } else {
                    console.error("Kullanıcı dokümanı Firestore'da bulunamadı:", user.uid);
                    showNotification('Kullanıcı profili bulunamadı. Lütfen yöneticinize başvurun.', 'error');
                    await signOut(auth); // Profil bulunamazsa çıkış yap
                }
            }
            catch (error) {
                console.error("Kullanıcı verisi yükleme hatası:", error);
                showNotification('Kullanıcı bilgileri yüklenirken hata oluştu: ' + error.message, 'error');
                await signOut(auth); // Hata durumunda çıkış yap
            }
        }

        // Günlük temizlik (eski araç kayıtlarını siler)
        async function checkDailyCleanup() {
            // Sadece adminler günlük temizliği yapabilir
            if (!currentUser || currentUser.role !== 'admin') {
                console.warn("Günlük temizlik admin yetkisi olmadan deneniyor. İşlem iptal edildi.");
                // showNotification("Günlük temizlik için yönetici yetkisi gerekli.", "error"); // Bu bildirim çok sık çıkabilir, sadece konsola logladık
                return; 
            }

            const today = new Date().toDateString();
            const lastCleanup = localStorage.getItem('lastCleanup');
            
            if (lastCleanup !== today) {
                await performDailyCleanup();
                localStorage.setItem('lastCleanup', today);
            }
        }

        async function performDailyCleanup() {
            try {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(23, 59, 59, 999); // Dün gece yarısı sonu

                const oldCarsQuery = query(
                    collection(db, 'cars'),
                    where('createdAt', '<', Timestamp.fromDate(yesterday))
                );
                
                const oldCarsSnapshot = await getDocs(oldCarsQuery);
                
                for (const carDoc of oldCarsSnapshot.docs) {
                    await deleteDoc(carDoc.ref); // Dokümanı sil
                }

                console.log(oldCarsSnapshot.size + ' eski araç kaydı temizlendi');
            } catch (error) {
                console.error("Günlük temizlik hatası:", error);
                showNotification("Günlük temizlik sırasında hata oluştu: " + error.message, "error");
            }
        }

        // Gerçek zamanlı dinleyicileri başlat
        function setupRealtimeListeners() {
            // Önceki dinleyicileri kapat
            unsubscribers.forEach(unsub => unsub());
            unsubscribers.length = 0;

            console.log("Real-time dinleyiciler başlatılıyor...");

            // Araçlar için dinleyici
            const carsQuery = query(collection(db, 'cars'), orderBy('createdAt', 'desc'));
            const carsUnsub = onSnapshot(carsQuery, (snapshot) => {
                const prevCarsCount = cars.length;
                cars.length = 0; // Diziyi temizle
                cars.push(...snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                })));
                
                console.log('Araç listesi güncellendi: ' + cars.length + ' araç');
                
                // Yeni araç eklenirse bildirim göster
                if (cars.length > prevCarsCount && prevCarsCount > 0) {
                    const newCar = cars[0]; // En yeni araç
                    showNotification('Yeni araç eklendi: ' + newCar.plate, 'info');
                }
                
                renderCarLists(); // Araç listelerini yeniden render et
                
                // Müşteri ekranındaysa aramayı tekrar yap
                const plateSearchInput = document.getElementById('plateSearch');
                if (document.getElementById('customerScreen').classList.contains('active') && 
                    plateSearchInput && plateSearchInput.value.trim().length >= 2) {
                    searchCar();
                }
            }, (error) => {
                console.error("Cars real-time listener hatası:", error);
                showNotification("Bağlantı sorunu: Araç verileri güncellenemiyor", "error");
            });
            unsubscribers.push(carsUnsub); // Dinleyiciyi kaydet

            // Admin ise geri bildirim ve kullanıcı dinleyicilerini başlat
            if (currentUser && currentUser.role === 'admin') {
                const feedbacksQuery = query(collection(db, 'feedbacks'), orderBy('createdAt', 'desc'));
                const feedbacksUnsub = onSnapshot(feedbacksQuery, (snapshot) => {
                    feedbacks.length = 0;
                    feedbacks.push(...snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    })));
                    console.log('Geri bildirim listesi güncellendi: ' + feedbacks.length + ' geri bildirim');
                    renderFeedbackInbox(); // Geri bildirim gelen kutusunu yeniden render et
                }, (error) => {
                    console.error("Feedbacks real-time listener hatası:", error);
                    // İzin hatası burada yakalanır ve yönetici bilgilendirilir.
                    showNotification("Geri bildirimler yüklenemiyor: İzin hatası. Firebase kurallarını kontrol edin.", "error");
                });
                unsubscribers.push(feedbacksUnsub);

                const usersQuery = query(collection(db, 'users'));
                const usersUnsub = onSnapshot(usersQuery, (snapshot) => {
                    users.length = 0;
                    users.push(...snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    })));
                    console.log('Kullanıcı listesi güncellendi: ' + users.length + ' kullanıcı');
                    renderUserList(); // Kullanıcı listesini yeniden render et
                }, (error) => {
                    console.error("Users real-time listener hatası:", error);
                    showNotification("Kullanıcılar yüklenemiyor: İzin hatası. Firebase kurallarını kontrol edin.", "error");
                });
                unsubscribers.push(usersUnsub);
            }
        }

        // Kimlik doğrulama fonksiyonları
        window.login = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showNotification('E-posta ve şifre gerekli', 'error');
                return;
            }

            try {
                console.log("Giriş deniyor:", email);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Firebase Auth başarılı:", userCredential.user.uid);
                showNotification('Giriş yapılıyor...', 'info');
                // onAuthStateChanged listener'ı loadUserData'yı çağıracak
                
            } catch (error) {
                console.error("Giriş hatası:", error);
                let errorMessage = 'Giriş başarısız';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Kullanıcı bulunamadı';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Hatalı şifre';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Geçersiz e-posta adresi';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Çok fazla hatalı deneme. Lütfen daha sonra tekrar deneyin.';
                } else {
                    errorMessage = 'Giriş başarısız: ' + error.message;
                }
                
                showNotification(errorMessage, 'error');
            }
        };

        window.logout = async function() {
            try {
                await signOut(auth);
                // Tüm dinleyicileri kapat
                unsubscribers.forEach(unsub => unsub());
                unsubscribers.length = 0;
                showNotification('Çıkış yapıldı', 'success');
                showCustomerSearch(); // Müşteri ekranına geri dön
            } catch (error) {
                console.error("Çıkış hatası:", error);
                showNotification('Çıkış yapılırken hata oluştu.', 'error');
            }
        };

        // UI Güncelleme fonksiyonları
        function updateUI() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const employeeBtn = document.getElementById('employeeBtn');
            const adminBtn = document.getElementById('adminBtn');
            const reportsBtn = document.getElementById('reportsBtn');

            if (currentUser) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'flex';
                
                if (currentUser.role === 'admin') {
                    employeeBtn.style.display = 'flex';
                    adminBtn.style.display = 'flex';
                    reportsBtn.style.display = 'flex';
                } else if (currentUser.role === 'employee') {
                    employeeBtn.style.display = 'flex';
                    adminBtn.style.display = 'none';
                    reportsBtn.style.display = 'none';
                }
            } else {
                // Giriş yapılmamışsa varsayılan durum
                loginBtn.style.display = 'flex';
                logoutBtn.style.display = 'none';
                employeeBtn.style.display = 'none';
                adminBtn.style.display = 'none';
                reportsBtn.style.display = 'none';
            }
        }

        // Ekran değiştirme fonksiyonu
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Bildirim gösterme fonksiyonu
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type; // Sınıfı temizle ve yenisini ekle
            notification.classList.add('show'); // Animasyonu başlat

            // 3 saniye sonra bildirimi gizle
            setTimeout(function() {
                notification.classList.remove('show');
            }, 3000);
        }

        // Ekran navigasyon fonksiyonları (window nesnesine atanmış)
        window.showLogin = function() {
            showScreen('loginScreen');
        };

        window.showCustomerSearch = function() {
            showScreen('customerScreen');
            document.getElementById('plateSearch').value = ''; // Arama kutusunu temizle
            document.getElementById('carResults').innerHTML = '<p style="text-align: center; color: #777;">Plaka numarasını girerek araç durumunu sorgulayabilirsiniz.</p>';
            document.getElementById('feedbackSection').style.display = 'none';
            searchedPlate = '';
            resetFeedbackForm(); // Geri bildirim formunu sıfırla
        };

        window.showEmployeePanel = function() {
            if (!currentUser || (currentUser.role !== 'employee' && currentUser.role !== 'admin')) {
                showNotification('Erişim yetkiniz yok', 'error');
                return;
            }
            showScreen('employeeScreen');
            renderCarLists(); // Çalışan paneli açıldığında araçları render et
        };

        window.showAdminPanel = function() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Admin erişimi gerekli', 'error');
                return;
            }
            showScreen('adminScreen');
            renderFeedbackInbox(); // Admin paneli açıldığında geri bildirimleri render et
            renderUserList(); // Kullanıcı listesini render et
        };

        window.showReports = function() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Admin erişimi gerekli', 'error');
                return;
            }
            showScreen('reportsScreen');
            generateReports(); // Raporları oluştur ve göster
            renderCarLists(); // Günlük araçları rapor ekranında göster
        };

        // Araç arama ve geri bildirim fonksiyonları
        window.searchCar = function() {
            const searchTerm = document.getElementById('plateSearch').value.trim().toUpperCase();
            const resultsDiv = document.getElementById('carResults');
            const feedbackSection = document.getElementById('feedbackSection');
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '<p style="text-align: center; color: #777;">Plaka numarasını girerek araç durumunu sorgulayabilirsiniz.</p>';
                feedbackSection.style.display = 'none';
                searchedPlate = '';
                return;
            }

            const filteredCars = cars.filter(car => 
                car.plate.toUpperCase().includes(searchTerm)
            );

            if (filteredCars.length === 0) {
                resultsDiv.innerHTML = '<div style="text-align: center; padding: 40px;">' +
                    '<i class="fa-solid fa-search" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>' +
                    '<p style="color: #777; font-size: 16px;">' +
                    '"<strong>' + searchTerm + '</strong>" plakası bulunamadı.' +
                    '</p>' +
                    '<p style="color: #999; font-size: 14px;">' +
                    'Farklı bir plaka deneyin veya çalışanlarımızla iletişime geçin.' +
                    '</p>' +
                    '</div>';
                feedbackSection.style.display = 'none';
                searchedPlate = '';
                return;
            }

            renderCars(resultsDiv, filteredCars, false); // Müşteri ekranında aksiyon butonları olmadan render et
            
            // Eğer tam eşleşme varsa geri bildirim formunu göster
            if (filteredCars.length === 1 && filteredCars[0].plate === searchTerm) {
                searchedPlate = filteredCars[0].plate;
                feedbackSection.style.display = 'block';
                resetFeedbackForm();
                showNotification(filteredCars[0].plate + ' plakası bulundu!', 'success');
            } else {
                feedbackSection.style.display = 'none';
                searchedPlate = '';
            }
        };

        // Yıldız derecelendirmesini ayarla
        window.setRating = function(rating) {
            selectedRating = rating;
            const stars = document.querySelectorAll('#starRating .star');
            const ratingText = document.getElementById('ratingText');
            
            const ratingTexts = {
                1: 'Çok Kötü',
                2: 'Kötü', 
                3: 'Orta',
                4: 'İyi',
                5: 'Mükemmel'
            };
            
            stars.forEach(function(star, index) {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
            
            ratingText.textContent = ratingTexts[rating] || 'Puan seçin';
        };

        // Geri bildirim gönder
        window.submitFeedback = async function() {
            if (selectedRating === 0) {
                showNotification('Lütfen bir puan verin!', 'error');
                return;
            }

            if (!searchedPlate) {
                showNotification('Önce bir araç sorgulayın!', 'error');
                return;
            }

            const comment = document.getElementById('feedbackComment').value.trim();
            const customerName = document.getElementById('customerNameFeedback').value.trim();

            try {
                const feedbackData = {
                    plate: searchedPlate,
                    rating: selectedRating,
                    comment: comment || null,
                    customerName: customerName || 'Anonim',
                    createdAt: Timestamp.now(),
                    isRead: false
                };

                await addDoc(collection(db, 'feedbacks'), feedbackData);
                showNotification('Geri bildiriminiz gönderildi. Teşekkürler!', 'success');
                resetFeedbackForm(); // Formu sıfırla
                
            } catch (error) {
                console.error('Geri bildirim gönderme hatası:', error);
                showNotification('Geri bildirim gönderilemedi. Tekrar deneyin.', 'error');
            }
        };

        // Geri bildirim formunu sıfırla
        function resetFeedbackForm() {
            selectedRating = 0;
            document.getElementById('feedbackComment').value = '';
            document.getElementById('customerNameFeedback').value = '';
            document.querySelectorAll('#starRating .star').forEach(function(star) {
                star.classList.remove('active');
            });
            document.getElementById('ratingText').textContent = 'Puan seçin';
        }

        // Araç yönetimi fonksiyonları
        window.addCar = async function() {
            if (!currentUser) {
                showNotification('Giriş yapmanız gerekli', 'error');
                return;
            }

            const plate = document.getElementById('newPlate').value.trim().toUpperCase();
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const serviceType = document.getElementById('serviceType').value;
            const estimatedTime = document.getElementById('estimatedTime').value;
            const price = document.getElementById('price').value;

            if (!plate) {
                showNotification('Plaka numarası gerekli', 'error');
                return;
            }

            const existingCar = cars.find(car => car.plate === plate);
            if (existingCar) {
                showNotification('Bu plaka zaten kayıtlı', 'error');
                return;
            }

            try {
                const carData = {
                    plate: plate,
                    customerName: customerName || null,
                    customerPhone: customerPhone || null,
                    serviceType: serviceType,
                    estimatedTime: estimatedTime ? parseInt(estimatedTime) : null,
                    price: price ? parseFloat(price) : null,
                    status: 'waiting', // Varsayılan durum
                    createdAt: Timestamp.now(), // Oluşturma zaman damgası
                    createdBy: currentUser.name,
                    createdById: currentUser.uid
                };

                await addDoc(collection(db, 'cars'), carData);
                
                // Formu temizle
                document.getElementById('newPlate').value = '';
                document.getElementById('customerName').value = '';
                document.getElementById('customerPhone').value = '';
                document.getElementById('serviceType').value = 'Dış Yıkama';
                document.getElementById('estimatedTime').value = '';
                document.getElementById('price').value = '';

                showNotification('Araç başarıyla eklendi', 'success');
            } catch (error) {
                console.error('Araç ekleme hatası:', error);
                showNotification('Araç ekleme hatası', 'error');
            }
        };

        window.updateCarStatus = async function(carId, newStatus) {
            if (!currentUser) {
                showNotification('Erişim yetkiniz yok', 'error');
                return;
            }

            try {
                await updateDoc(doc(db, 'cars', carId), {
                    status: newStatus,
                    updatedAt: Timestamp.now(),
                    updatedBy: currentUser.name
                });

                const statusTexts = {
                    'waiting': 'Sırada',
                    'washing': 'Yıkanıyor',
                    'drying': 'Kurutuluyor',
                    'ready': 'Hazır',
                    'completed': 'Tamamlandı'
                };

                showNotification('Durum güncellendi: ' + statusTexts[newStatus], 'success');
            } catch (error) {
                console.error('Durum güncelleme hatası:', error);
                showNotification('Durum güncelleme hatası', 'error');
            }
        };

        window.deleteCar = async function(carId) {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Admin yetkisi gerekli', 'error');
                return;
            }

            // Silme onayı için özel bir modal/dialog kullanın, alert yerine
            if (!confirm('Bu aracı silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'cars', carId));
                showNotification('Araç silindi', 'success');
            } catch (error) {
                console.error('Araç silme hatası:', error);
                showNotification('Araç silme hatası', 'error');
            }
        };

        // Kullanıcı yönetimi fonksiyonları
        window.addUser = async function() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Admin yetkisi gerekli', 'error');
                return;
            }

            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const name = document.getElementById('newUserName').value.trim();
            const role = document.getElementById('newUserRole').value;

            if (!email || !password || !name) {
                showNotification('Tüm alanlar gerekli', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('Şifre en az 6 karakter olmalı', 'error');
                return;
            }

            try {
                // Firebase Authentication'da kullanıcı oluştur
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Firestore'a kullanıcı bilgilerini kaydet
                await setDoc(doc(db, 'users', userCredential.user.uid), {
                    email: email,
                    name: name,
                    role: role,
                    createdAt: Timestamp.now(),
                    createdBy: currentUser.name
                });

                // Formu temizle
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPassword').value = '';
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserRole').value = 'employee';

                showNotification('Kullanıcı başarıyla eklendi', 'success');
            } catch (error) {
                console.error('Kullanıcı ekleme hatası:', error);
                showNotification('Kullanıcı ekleme hatası: ' + error.message, 'error');
            }
        };

        // Geri bildirim yönetimi
        window.markFeedbackAsRead = async function(feedbackId) {
            try {
                await updateDoc(doc(db, 'feedbacks', feedbackId), {
                    isRead: true
                });
                showNotification('Geri bildirim okundu olarak işaretlendi', 'success');
            } catch (error) {
                console.error('Geri bildirim güncelleme hatası:', error);
                showNotification('İşlem başarısız', 'error');
            }
        };

        window.deleteFeedback = async function(feedbackId) {
            if (!confirm('Bu geri bildirimi silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'feedbacks', feedbackId));
                showNotification('Geri bildirim silindi', 'success');
            } catch (error) {
                console.error('Geri bildirim silme hatası:', error);
                showNotification('Silme işlemi başarısız', 'error');
            }
        };

        // Render fonksiyonları (UI güncellemeleri için)
        function renderCars(container, carsToRender, showActions) {
            if (carsToRender.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777;">Araç bulunamadı.</p>';
                return;
            }

            const statusTexts = {
                'waiting': 'Sırada',
                'washing': 'Yıkanıyor',
                'drying': 'Kurutuluyor',
                'ready': 'Hazır',
                'completed': 'Tamamlandı'
            };

            const carCards = carsToRender.map(function(car) {
                const createdAt = car.createdAt && car.createdAt.toDate ? car.createdAt.toDate() : new Date(car.createdAt);
                const timeStr = createdAt.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                
                let actionsHtml = '';
                if (showActions) {
                    actionsHtml = '<div class="status-controls">' +
                        '<button class="status-btn ' + (car.status === 'waiting' ? 'active' : '') + '" onclick="updateCarStatus(\'' + car.id + '\', \'waiting\')">' +
                        '<i class="fa-solid fa-clock"></i> Sırada</button>' +
                        '<button class="status-btn ' + (car.status === 'washing' ? 'active' : '') + '" onclick="updateCarStatus(\'' + car.id + '\', \'washing\')">' +
                        '<i class="fa-solid fa-water"></i> Yıkanıyor</button>' +
                        '<button class="status-btn ' + (car.status === 'drying' ? 'active' : '') + '" onclick="updateCarStatus(\'' + car.id + '\', \'drying\')">' +
                        '<i class="fa-solid fa-wind"></i> Kurutuluyor</button>' +
                        '<button class="status-btn ' + (car.status === 'ready' ? 'active' : '') + '" onclick="updateCarStatus(\'' + car.id + '\', \'ready\')">' +
                        '<i class="fa-solid fa-check"></i> Hazır</button>' +
                        '<button class="status-btn ' + (car.status === 'completed' ? 'active' : '') + '" onclick="updateCarStatus(\'' + car.id + '\', \'completed\')">' +
                        '<i class="fa-solid fa-flag-checkered"></i> Tamamlandı</button>' +
                        '</div>';
                    
                    if (currentUser && currentUser.role === 'admin') {
                        actionsHtml += '<div class="button-group">' +
                            '<button class="btn btn-danger" onclick="deleteCar(\'' + car.id + '\')">' +
                            '<i class="fa-solid fa-trash"></i> Sil</button></div>';
                    }
                }

                return '<div class="car-card">' +
                    '<div class="car-header">' +
                    '<div class="plate-number">' + car.plate + '</div>' +
                    '<div class="status ' + car.status + '">' + statusTexts[car.status] + '</div>' +
                    '</div>' +
                    '<div class="car-details">' +
                    '<div class="detail-item">' +
                    '<div class="detail-label">Müşteri</div>' +
                    '<div class="detail-value">' + (car.customerName || 'Belirtilmemiş') + '</div>' +
                    '</div>' +
                    '<div class="detail-item">' +
                    '<div class="detail-label">Telefon</div>' +
                    '<div class="detail-value">' + (car.customerPhone || 'Belirtilmemiş') + '</div>' +
                    '</div>' +
                    '<div class="detail-item">' +
                    '<div class="detail-label">Hizmet</div>' +
                    '<div class="detail-value">' + car.serviceType + '</div>' +
                    '</div>' +
                    '<div class="detail-item">' +
                    '<div class="detail-label">Süre</div>' +
                    '<div class="detail-value">' + (car.estimatedTime ? car.estimatedTime + ' dk' : 'Belirtilmemiş') + '</div>' +
                    '</div>' +
                    '<div class="detail-item">' +
                    '<div class="detail-label">Fiyat</div>' +
                    '<div class="detail-value">' + (car.price ? '₺' + car.price.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'Belirtilmemiş') + '</div>' +
                    '</div>' +
                    '<div class="detail-item">' +
                    '<div class="detail-label">Giriş Saati</div>' +
                    '<div class="detail-value">' + timeStr + '</div>' +
                    '</div>' +
                    '</div>' +
                    actionsHtml +
                    '</div>';
            }).join('');

            container.innerHTML = carCards;
        }

        // Araç listelerini render et (çalışan ve raporlar için)
        function renderCarLists() {
            const employeeList = document.getElementById('employeeCarList');
            const dailyList = document.getElementById('dailyCarsList');

            if (employeeList && document.getElementById('employeeScreen').classList.contains('active')) {
                const activeCars = cars.filter(function(car) { return car.status !== 'completed'; });
                renderCars(employeeList, activeCars, true); // Çalışan panelinde aksiyon butonları göster
            }

            if (dailyList && document.getElementById('reportsScreen').classList.contains('active')) {
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const dailyCars = cars.filter(function(car) {
                    const carDate = car.createdAt && car.createdAt.toDate ? car.createdAt.toDate() : new Date(car.createdAt);
                    return carDate >= todayStart;
                });
                renderCars(dailyList, dailyCars, false); // Rapor ekranında aksiyon butonları gösterme
            }
        }

        // Kullanıcı listesini render et
        function renderUserList() {
            const userList = document.getElementById('userList');
            if (!userList || !currentUser || currentUser.role !== 'admin') return; // Sadece adminler için

            if (users.length === 0) {
                userList.innerHTML = '<p style="text-align: center; color: #777;">Kullanıcı bulunamadı.</p>';
                return;
            }

            const userCards = users.map(function(user) {
                const createdDate = user.createdAt && user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString('tr-TR') : 'Bilinmiyor';
                return '<div class="car-card">' + // car-card sınıfını yeniden kullan
                    '<div class="car-header">' +
                    '<div class="plate-number" style="font-size: 20px;">' + user.name + '</div>' +
                    '<div class="status ' + (user.role === 'admin' ? 'completed' : 'ready') + '">' + // Renklendirme için durum sınıflarını kullan
                    (user.role === 'admin' ? 'Admin' : 'Çalışan') +
                    '</div>' +
                    '</div>' +
                    '<div class="car-details">' +
                    '<div class="detail-item">' +
                    '<div class="detail-label">E-posta</div>' +
                    '<div class="detail-value">' + user.email + '</div>' +
                    '</div>' +
                    '<div class="detail-item">' +
                    '<div class="detail-label">Oluşturulma</div>' +
                    '<div class="detail-value">' + createdDate + '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            }).join('');

            userList.innerHTML = userCards;
        }

        // Geri bildirim gelen kutusunu render et
        function renderFeedbackInbox() {
            const feedbackInbox = document.getElementById('feedbackInbox');
            if (!feedbackInbox || !currentUser || currentUser.role !== 'admin') return; // Sadece adminler için

            if (feedbacks.length === 0) {
                feedbackInbox.innerHTML = '<div class="no-feedback">' +
                    '<i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 15px; color: #ddd;"></i>' +
                    '<p>Henüz geri bildirim bulunmuyor.</p>' +
                    '</div>';
                return;
            }

            const unreadCount = feedbacks.filter(function(f) { return !f.isRead; }).length;
            
            const feedbackItems = feedbacks.map(function(feedback) {
                const createdAt = feedback.createdAt && feedback.createdAt.toDate ? feedback.createdAt.toDate() : new Date();
                const timeStr = createdAt.toLocaleString('tr-TR');
                
                let starsHtml = '';
                for (let i = 0; i < 5; i++) {
                    starsHtml += '<span class="star ' + (i < feedback.rating ? 'active' : '') + '">⭐</span>';
                }

                const unreadStyle = feedback.isRead ? '' : 'border-left-color: #ff6b6b; background: #fff5f5;'; // Okunmadıysa stil
                const newBadge = !feedback.isRead ? '<span style="background: #ff6b6b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px;">YENİ</span>' : '';
                const commentSection = feedback.comment ? '<div class="feedback-comment">' +
                    '<i class="fa-solid fa-quote-left"></i> ' +
                    feedback.comment +
                    '</div>' : '';
                const readButton = !feedback.isRead ? '<button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="markFeedbackAsRead(\'' + feedback.id + '\')">' +
                    '<i class="fa-solid fa-check"></i> Okundu İşaretle</button>' : '';

                return '<div class="feedback-item" style="' + unreadStyle + '">' +
                    '<div class="feedback-header">' +
                    '<div>' +
                    '<strong>' + feedback.customerName + '</strong>' +
                    '<span style="margin-left: 10px; color: #666; font-size: 14px;">(' + feedback.plate + ')</span>' +
                    newBadge +
                    '</div>' +
                    '<div class="feedback-rating">' + starsHtml + '</div>' +
                    '</div>' +
                    '<div class="feedback-meta">' +
                    '<span><i class="fa-solid fa-calendar"></i> ' + timeStr + '</span>' +
                    '<span><i class="fa-solid fa-star"></i> ' + feedback.rating + '/5</span>' +
                    '</div>' +
                    commentSection +
                    '<div class="feedback-actions">' +
                    readButton +
                    '<button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteFeedback(\'' + feedback.id + '\')">' +
                    '<i class="fa-solid fa-trash"></i> Sil</button>' +
                    '</div>' +
                    '</div>';
            }).join('');

            const unreadBadge = unreadCount > 0 ? '• <span style="background: #ff6b6b; padding: 4px 8px; border-radius: 10px; margin-left: 8px;">' + unreadCount + ' Yeni</span>' : '';

            feedbackInbox.innerHTML = '<div style="margin-bottom: 20px; text-align: center;">' +
                '<span style="background: #4a5ee5; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold;">' +
                '<i class="fa-solid fa-envelope"></i> ' + feedbacks.length + ' Toplam Geri Bildirim ' +
                unreadBadge +
                '</span>' +
                '</div>' +
                feedbackItems;
        }

        // Raporları oluştur ve güncelle
        function generateReports() {
            const today = new Date();
            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            
            const todayCars = cars.filter(function(car) {
                const carDate = car.createdAt && car.createdAt.toDate ? car.createdAt.toDate() : new Date(car.createdAt);
                return carDate >= todayStart;
            });

            const activeCars = todayCars.filter(function(car) { return car.status !== 'completed'; });
            const completedCars = todayCars.filter(function(car) { return car.status === 'completed'; });
            const totalRevenue = completedCars.reduce(function(sum, car) { return sum + (car.price || 0); }, 0);

            const todayFeedbacks = feedbacks.filter(function(feedback) {
                const feedbackDate = feedback.createdAt && feedback.createdAt.toDate ? feedback.createdAt.toDate() : new Date(feedback.createdAt);
                return feedbackDate >= todayStart;
            });

            const avgRating = todayFeedbacks.length > 0 
                ? (todayFeedbacks.reduce(function(sum, f) { return sum + f.rating; }, 0) / todayFeedbacks.length).toFixed(1)
                : '0.0';

            document.getElementById('totalCars').textContent = todayCars.length;
            document.getElementById('activeCars').textContent = activeCars.length;
            document.getElementById('completedCars').textContent = completedCars.length;
            document.getElementById('totalRevenue').textContent = '₺' + totalRevenue.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('avgRating').textContent = avgRating;
        }

        // Olay işleyicilerini başlat
        function initializeEventHandlers() {
            document.addEventListener('click', function(e) {
                if (e.target.matches('#starRating .star')) {
                    const rating = parseInt(e.target.getAttribute('data-rating'));
                    setRating(rating);
                }
            });

            document.addEventListener('keypress', function(e) {
                // Giriş ekranında Enter tuşu ile giriş yapma
                if (e.key === 'Enter' && document.getElementById('loginScreen').classList.contains('active')) {
                    const email = document.getElementById('email');
                    const password = document.getElementById('password');
                    if (email === document.activeElement || password === document.activeElement) {
                        login();
                    }
                }
            });
        }

        // Uygulamayı başlat
        async function initApp() {
            await initFirebase(); // Firebase'i başlat
            initializeEventHandlers(); // Olay işleyicilerini kur
        }
        
        // Uygulamayı yükle
        initApp();

        console.log("Oto Yıkama Takip Sistemi - Tek Sayfa Uygulaması Başlatıldı");
    </script>
</body>
</html>
